{% extends 'base.html' %}

{% block titulo %}
Crear artículo
{% endblock titulo %}

{% block contenido %}
<h2>Crear nuevo artículo</h2>

<form class="crear_articulo" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}

    <p>
        <label for="id_imagenes">Imágenes:</label>
        <input type="file" id="id_imagenes" multiple accept="image/*">
    </p>

    <div id="previews" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>

    <input type="file" name="imagenes" id="imagenes_hidden" style="display:none;" multiple>

    <script>
    // Manejo incremental de selección de archivos: acumulamos en un DataTransfer
    (function(){
        const input = document.getElementById('id_imagenes');
        const hidden = document.getElementById('imagenes_hidden');
        const previews = document.getElementById('previews');
        const dt = new DataTransfer();

        function updateHiddenAndPreviews(){
            // Volcar DataTransfer al input oculto
            hidden.files = dt.files;
            // Limpiar previews
            previews.innerHTML = '';
            for(let i=0;i<dt.files.length;i++){
                const file = dt.files[i];
                const url = URL.createObjectURL(file);
                const wrapper = document.createElement('div');
                wrapper.style.position='relative';
                wrapper.style.width='120px';
                wrapper.style.height='80px';
                wrapper.style.border='1px solid #ddd';
                wrapper.style.padding='4px';
                wrapper.style.boxSizing='border-box';
                const img = document.createElement('img');
                img.src = url; img.style.maxWidth='100%'; img.style.maxHeight='100%';
                const btn = document.createElement('button');
                btn.type = 'button'; btn.textContent = '✕';
                btn.style.position='absolute'; btn.style.top='2px'; btn.style.right='2px';
                btn.style.background='rgba(0,0,0,0.6)'; btn.style.color='white'; btn.style.border='none';
                btn.style.cursor='pointer';
                btn.addEventListener('click', ()=>{
                    // remover archivo de DataTransfer
                    const newDt = new DataTransfer();
                    for(let j=0;j<dt.files.length;j++){
                        if(j===i) continue;
                        newDt.items.add(dt.files[j]);
                    }
                    // copiar de vuelta
                    while(dt.items.length) dt.items.remove(0);
                    for(let k=0;k<newDt.files.length;k++) dt.items.add(newDt.files[k]);
                    updateHiddenAndPreviews();
                });
                wrapper.appendChild(img); wrapper.appendChild(btn);
                previews.appendChild(wrapper);
            }
        }

        input.addEventListener('change', (e)=>{
            for(const file of e.target.files){
                dt.items.add(file);
            }
            // resetear input para permitir volver a seleccionar los mismos archivos
            input.value = '';
            updateHiddenAndPreviews();
        });
    })();
    </script>

   <button type="submit">Publicar</button>
    <a href="{% url 'blog:lista_articulos' %}" class="btn-cancel">Cancelar</a>
</form>
{% endblock contenido %}
